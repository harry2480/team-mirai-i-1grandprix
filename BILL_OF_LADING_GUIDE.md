# 🚢 船荷証券電子化 - バッチ分析実行ガイド

## 概要

党首のプロンプト文（`20251123_generate-aggregate-report-v2.ts`）と、我々の汎用分析エンジンを統合しました。

### 統合のメリット

| 要素 | 党首版 | 統合版 |
|------|--------|--------|
| **プロンプト品質** | ✅ 高品質（引用強制、学術的中立性） | ✅ 継承 |
| **バッチ処理** | ✅ あり（700K tokens/batch） | ✅ 継承 |
| **仮説管理** | ❌ ハードコード（AI基本計画専用） | ✅ **外部設定ファイル** |
| **テーマ切り替え** | ❌ 手動編集必要 | ✅ **自動（slug指定のみ）** |
| **自動仮説生成** | ❌ なし | ✅ **あり（Phase 2）** |

---

## セットアップ

### 1. 環境変数の設定

`.env.local` ファイルを作成：

```env
# データベース接続（党首から引き継ぎ）
POSTGRES_URL=your_postgres_url_here
POSTGRES_URL_NON_POOLING=your_postgres_url_non_pooling_here

# OpenRouter API Key ($50分)
AI_GATEWAY_API_KEY=sk-or-v1-...

# モデル設定
DEFAULT_MODEL=google/gemini-2.0-flash-exp
MAX_OUTPUT_TOKENS=64000
TOKENS_PER_BATCH=700000
```

### 2. 依存関係のインストール

```powershell
npm install
```

追加で必要なパッケージ:
- `pg` - PostgreSQL接続
- `ai` - Vercel AI SDK

```powershell
npm install pg ai
npm install --save-dev @types/pg
```

---

## 実行方法

### 基本的な実行（事前定義仮説を使用）

```powershell
npm run batch-analyze -- bill-of-lading
```

**処理フロー:**
1. `src/config/themes/bill-of-lading.ts` から仮説7個を読み込み
2. データベースから船荷証券のセッションデータを取得
3. 700Kトークンごとにバッチ分割
4. 各バッチで党首プロンプトを実行
5. `reports/` にレポート保存

### 自動仮説生成モード

```powershell
npm run batch-analyze -- bill-of-lading --auto-hypotheses
```

**処理フロー:**
1. トークン数上位5件のセッションをサンプリング
2. Geminiに「船荷証券で検証すべき仮説は？」と質問
3. 自動生成された仮説を使用して本分析

---

## 仮説の確認

現在の船荷証券用仮説（`src/config/themes/bill-of-lading.ts`）:

1. **B1: 効率化への期待** - 貿易手続きの時間・コスト削減
2. **B2: セキュリティとサイバーリスク** - 電子データ改ざん・なりすまし
3. **B3: 中小企業への負担** - システム導入費用・IT人材不足
4. **B4: 国際標準との整合性** - MLETR準拠、他国システムとの互換性
5. **B5: 紙文化との共存** - 移行期間の二重運用
6. **B6: 法的有効性と紛争解決** - 国際紛争時の準拠法
7. **B7: BCP対応** - システム障害時のバックアップ

これらの仮説は、コンペの評価基準に沿って設計されています。

---

## プロンプトの構造（党首版を継承）

```
1. インタビュー背景の説明
   ↓
2. 検証対象の仮説（外部注入）
   ↓
3. 党首の12個の注意事項
   - 引用強制「#セッション番号」
   - 数量表現禁止「多くの参加者が」等
   - 価値判断禁止「優れた提案」等
   - 学術的中立性
   ↓
4. セッションデータ
   ↓
5. LLM生成
```

---

## 出力例

```markdown
# 船荷証券の電子化法案 - 集約レポート

## まとめ

船荷証券の電子化に対する意見は、効率化への期待とセキュリティリスクへの懸念の間で二分されている。特に中小企業においては、システム導入の費用負担とIT人材確保が大きな障壁として認識されている。

国際標準への適合は必須との認識がある一方で、日本独自の商慣行（紙ベースの信頼関係）との両立が課題である...

## 仮説1: 効率化への期待

### 支持する意見

- "紙の船荷証券は郵送に1週間かかるが、電子化すれば即日で済む。これは大きなコスト削減になる"(#12)
- "ペーパーレス化で保管スペースも不要になり、書類紛失のリスクもなくなる"(#34)

### 反論・異なる視点

- "効率化は理解できるが、システム障害時のバックアップがないと逆にリスクが高まる"(#56)

### 検証結果

効率化への期待は広く共有されているが、システム信頼性への懸念も強い...

## 仮説2: セキュリティとサイバーリスク

...
```

---

## トラブルシューティング

### エラー: `POSTGRES_URL not found`

`.env.local` にデータベース接続文字列を設定してください。

### エラー: `AI_GATEWAY_API_KEY not found`

OpenRouter APIキーを設定してください。取得先: https://openrouter.ai/

### エラー: `Theme config not found for slug: xxx`

利用可能なテーマ:
- `bill-of-lading` - 船荷証券の電子化
- `ai-plan-test` - 人工知能基本計画
- `marumie-shikin-user` - 政治資金ツール

---

## コンペ向け改善アイデア

1. **並列処理モード**: 党首の `--mode=parallel` を統合
2. **仮説の動的調整**: エビデンスが多い仮説を自動で詳細化
3. **比較レポート**: 複数テーマの結果を横並び比較

---

## まとめ

✅ 党首の優れたプロンプト設計（引用強制、中立性）を継承  
✅ テーマ切り替えを自動化（設定ファイルのみ）  
✅ 自動仮説生成でデータドリブンな分析が可能

**船荷証券のバッチ分析、準備完了です！🚢**
